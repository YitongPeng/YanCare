"""
初始化知识库 - 导入文档到向量数据库

运行方式：
cd backend
python -m scripts.init_knowledge
"""
import sys
import os
import re

# 添加项目根目录到路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.services.rag import rag_service


# ============ 知识库内容 ============

# 服务说明
SERVICE_DOCS = [
    {
        "id": "service_shampoo_intro",
        "content": """仁味康中药洗发水介绍：
中药洗发水含有天然中药成分，如人参、薄荷、首乌等，温和无刺激。
仁味康洗发水有五种配方，针对不同发质和头皮情况。""",
        "metadata": {"category": "产品", "type": "洗发水"}
    },
    {
        "id": "service_shampoo_1",
        "content": """控油去屑平衡洗发乳（油性发质）：
针对油性头发，抑制头皮细菌和真菌感染，减少油脂堆积，控油防脱，保持清爽不油腻。
适合人群：头发容易出油、头皮油腻的人群。""",
        "metadata": {"category": "产品", "type": "洗发水", "target": "油性"}
    },
    {
        "id": "service_shampoo_2",
        "content": """轻柔防断去屑洗发乳（干性/敏感发质）：
适合干性、敏感性头发及烫发人群。温和保湿滋润，消除干屑，锁住水分，修复受损，减少分叉。
适合人群：头发干枯、头皮敏感、烫染后的人群。""",
        "metadata": {"category": "产品", "type": "洗发水", "target": "干性"}
    },
    {
        "id": "service_shampoo_3",
        "content": """丰盈蓬松强韧洗发乳（细软发质）：
适用于贴头皮、细软发质人群，增加蓬松感和立体感，改善发质韧度，增加发量和光泽。
适合人群：头发细软、发量少、头发贴头皮的人群。""",
        "metadata": {"category": "产品", "type": "洗发水", "target": "细软"}
    },
    {
        "id": "service_shampoo_4",
        "content": """姜汁平衡洗发乳（脱发人群）：
促进头发生长，滋养头皮，抑制头皮屑，预防脱发，促进头皮血液循环。
适合人群：有脱发困扰、希望促进头发生长的人群。""",
        "metadata": {"category": "产品", "type": "洗发水", "target": "脱发"}
    },
    {
        "id": "service_shampoo_5",
        "content": """草本植萃精华赋活霜（护发素）：
纯中药护发素，形成保护膜，减少紫外线和化学成分伤害，防止分叉断裂，滋养锁水，增加弹性光泽。
这是一款护发素，配合洗发水使用效果更好。""",
        "metadata": {"category": "产品", "type": "护发素"}
    },
    {
        "id": "service_wash",
        "content": """姜疗洗头服务：
时长约20分钟，配合按摩膏使用。
功效：清理头皮油脂和堆积物，帮助头皮吸收营养，去屑止痒，滋养头皮，促进头发生长。
还能活经通脉、提神醒脑、缓解头痛、消除疲劳、驱除体内风寒。
按摩膏具有护发素作用，滋养头发，锁住水分，增加发质弹性。
洗头服务可以免费体验店内任意洗发产品。""",
        "metadata": {"category": "服务", "type": "洗头", "duration": "20分钟"}
    },
    {
        "id": "service_soak",
        "content": """中药泡头服务：
时长约45分钟，真材实料看得见！
使用无患子、皂荚、何首乌、枸杞、侧柏叶、当归、姜根、柠檬果、茶籽、人参根等14种中药，经6小时熬制。现熬现泡，水循环系统反复冲泡。
功效：补充头发养分，改善头皮环境，使头发乌黑亮泽，祛风散寒，治疗头晕头痛，改善睡眠。
适宜人群：头皮屑多、头皮痒、须发早白、脱发、毛囊炎、头发干枯分叉。
注意：泡头前需要先洗头。""",
        "metadata": {"category": "服务", "type": "泡头", "duration": "45分钟"}
    },
    {
        "id": "service_care",
        "content": """磁疗梳中药养发服务：
自古以来，梳头是保健养生之道，"头梳千遍，病少一半"。

磁疗梳作用：促进头皮血液循环，缓解头痛、头晕、颈部僵硬，改善睡眠，增强记忆力，减轻焦虑和压力。

中药养发：何首乌、黑芝麻、当归等中药富含营养，为头发提供蛋白质、维生素、矿物质，增强头发韧性与光泽。
侧柏叶、干姜等可刺激头皮血管扩张，为毛囊输送更多营养，促进头发生长。

我们会根据客人头发情况，量身定制养发方案。""",
        "metadata": {"category": "服务", "type": "养发", "duration": "50分钟"}
    },
]

# 卡种信息
CARD_DOCS = [
    {
        "id": "card_wash",
        "content": """洗头卡：
价格：1000元/50次
有效期：无期限
单次价格：20元/次（原价60元）
服务：洗头（约30分钟）
适合人群：日常洗护需求，来店频率较高的顾客。""",
        "metadata": {"category": "卡种", "type": "洗头卡"}
    },
    {
        "id": "card_soak",
        "content": """泡头卡：
价格：1800元/30次
有效期：半年
单次价格：60元/次（原价128元）
服务：泡头（约50分钟，含洗头）
注意：泡头必洗头
适合人群：头皮问题较多，需要深层清洁的顾客。""",
        "metadata": {"category": "卡种", "type": "泡头卡"}
    },
    {
        "id": "card_premium",
        "content": """尊享保养卡：
价格：13800元/无限次
有效期：1年
服务：养发（约50分钟）
建议频率：每日1次
适合人群：养发需求强烈，希望长期密集养护的顾客。""",
        "metadata": {"category": "卡种", "type": "尊享保养卡"}
    },
    {
        "id": "card_guben",
        "content": """固本保养卡：
价格：5000元/60次
有效期：1.5年
单次价格：约83元/次（原价128元）
服务：养发（约50分钟）
建议频率：每周1次以上
适合人群：希望长期养护，使用频率中等的顾客。""",
        "metadata": {"category": "卡种", "type": "固本保养卡"}
    },
    {
        "id": "card_deep",
        "content": """深度保养卡：
价格：6000元/100次
有效期：1年
单次价格：60元/次（原价128元）
服务：养发（约50分钟）
建议频率：每周2次以上
适合人群：养护需求较高，希望在一年内密集养护的顾客。""",
        "metadata": {"category": "卡种", "type": "深度保养卡"}
    },
    {
        "id": "card_strong",
        "content": """强效保养卡：
价格：9000元/180次
有效期：1年
单次价格：50元/次（原价128元）
服务：养发（约50分钟）
适合人群：高频使用，追求性价比的顾客。""",
        "metadata": {"category": "卡种", "type": "强效保养卡"}
    },
    {
        "id": "card_combo",
        "content": """综合卡（洗泡养）：
价格：6000元/100次
有效期：1年
服务：可做洗头、泡头或养发
扣次规则：洗头扣1次，泡头或养发各扣2次，洗泡养都做扣2次
适合人群：需要多种服务，希望灵活选择的顾客。""",
        "metadata": {"category": "卡种", "type": "综合卡"}
    },
    {
        "id": "card_why",
        "content": """为什么建议办卡而不是单次？
1. 价格优惠：办卡后单次价格基本低于原价50%
2. 养护效果：头发养护需要持续进行，定期护理效果更好
3. 灵活安排：卡项可以在有效期内自由安排使用时间
4. 可以转让：卡可以转让给亲戚朋友使用""",
        "metadata": {"category": "卡种", "type": "办卡说明"}
    },
]

# FAQ
FAQ_DOCS = [
    {
        "id": "faq_legit_1",
        "content": """问：燕斛堂是正规机构吗？
答：燕斛堂是一家提供头皮与头发日常养护服务的专业门店，所使用的洗护产品与养护流程均遵循规范要求。
需要说明的是，燕斛堂并非医疗机构，也不提供任何医疗诊断或治疗服务，而是致力于为顾客提供舒适、安心的日常养护体验。""",
        "metadata": {"category": "FAQ", "type": "合规"}
    },
    {
        "id": "faq_legit_2",
        "content": """问：燕斛堂是医疗机构吗？会不会涉及治疗？
答：燕斛堂并非医疗机构，所有服务项目均以头皮与头发的保养与护理为主，不涉及医学诊断、治疗或医疗干预。
如您有明确的健康或疾病问题，建议咨询专业医疗机构。""",
        "metadata": {"category": "FAQ", "type": "合规"}
    },
    {
        "id": "faq_legit_3",
        "content": """问：你们和医院/植发机构有什么区别？
答：燕斛堂不提供植发或医疗相关服务，而是通过日常洗护、养护与头皮护理流程，帮助顾客改善头皮环境、提升头发状态与整体护理体验。
适合希望进行长期日常养护的人群。""",
        "metadata": {"category": "FAQ", "type": "合规"}
    },
    {
        "id": "faq_product_1",
        "content": """问：你们用的是什么洗发水？
答：燕斛堂使用的是仁味康中药洗发水系列，根据不同头皮与发质情况提供多种选择，包括控油、干性、细软发质等类型。
请问您的头皮是属于什么情况呢？""",
        "metadata": {"category": "FAQ", "type": "产品"}
    },
    {
        "id": "faq_product_2",
        "content": """问：洗发水里都有什么成分？
答：中药洗发水通常含有如人参、薄荷、何首乌等天然中药成分，配方以温和、低刺激为原则，针对不同发质进行区分设计。
您想了解哪种洗发水呢？""",
        "metadata": {"category": "FAQ", "type": "产品"}
    },
    {
        "id": "faq_product_3",
        "content": """问：会不会刺激头皮？敏感头皮能用吗？
答：燕斛堂部分洗护产品适用于偏干性或敏感性头皮，整体配方以温和护理为主。
实际使用过程中，会根据个人头皮状况进行适当调整，如有任何不适，也可随时告知理疗师。""",
        "metadata": {"category": "FAQ", "type": "产品"}
    },
    {
        "id": "faq_product_4",
        "content": """问：孕期/特殊人群可以使用吗？
答：一般情况下，洗护与养护服务以温和护理为主。如您处于孕期或有特殊身体状况，建议在服务前提前告知工作人员，我们会结合您的情况进行适当安排。
如过程中出现任何不适，请及时告知并根据需要咨询专业医生。
如果您担心孕后激素水平下降而掉发严重，部分产品和养护可以改善产后脱发。""",
        "metadata": {"category": "FAQ", "type": "产品"}
    },
    {
        "id": "faq_service_wash_1",
        "content": """问：洗头和普通洗头有什么区别？
答：姜疗洗头会配合按摩膏进行，清理头皮油脂与堆积物，整个过程约20分钟，注重头皮清洁与放松体验。
而且洗头服务可免费体验店内任意洗发产品，方便您了解不同产品的使用感受。""",
        "metadata": {"category": "FAQ", "type": "服务-洗头"}
    },
    {
        "id": "faq_service_wash_2",
        "content": """问：洗头大概多久？
答：单次洗头服务约为20分钟。""",
        "metadata": {"category": "FAQ", "type": "服务-洗头"}
    },
    {
        "id": "faq_service_soak_1",
        "content": """问：泡头是做什么的？
答：中药泡头使用多种草本原料熬制后进行循环冲泡，目的是改善头皮环境、滋养头发，整个过程约45分钟。""",
        "metadata": {"category": "FAQ", "type": "服务-泡头"}
    },
    {
        "id": "faq_service_soak_2",
        "content": """问：泡头用的中药是真的吗？
答：泡头使用多种草本原料，经长时间熬制后使用，原料可见、现熬现泡。真材实料看得见！""",
        "metadata": {"category": "FAQ", "type": "服务-泡头"}
    },
    {
        "id": "faq_service_soak_3",
        "content": """问：哪些人适合泡头？
答：头皮屑多、易出油、脱发困扰的人群都适合泡头。
青少年发育期油脂分泌旺盛，容易产生头皮屑、毛囊炎，也很适合。
日常保养老少皆宜。""",
        "metadata": {"category": "FAQ", "type": "服务-泡头"}
    },
    {
        "id": "faq_service_care_1",
        "content": """问：养发具体是做什么？
答：养发包含磁疗梳与中药养护过程，通过梳理、按摩等方式，帮助放松头皮，提升整体养护体验。
我们会根据个人情况进行调整，量身定制养发方案。""",
        "metadata": {"category": "FAQ", "type": "服务-养发"}
    },
    {
        "id": "faq_service_care_2",
        "content": """问：磁疗梳安全吗？
答：磁疗梳属于辅助体验型工具，主要用于放松与护理过程中的辅助操作。
相关专利和安全认证可在门店进行了解，如有疑问也可随时咨询理疗师。""",
        "metadata": {"category": "FAQ", "type": "服务-养发"}
    },
    {
        "id": "faq_effect_1",
        "content": """问：多久能看到变化？
答：每个人的情况不同，效果因人而异。
白发转黑：一般20天后能看到根部有黑发新生。
脱发改善：需要根据具体情况判断，详情请咨询理疗师。
建议您先到店体验，让理疗师为您评估。""",
        "metadata": {"category": "FAQ", "type": "效果"}
    },
    {
        "id": "faq_effect_2",
        "content": """问：做了就一定有用吗？
答：养护效果因人而异，但我们有很多顾客反馈效果不错。
建议您先体验一下，实际感受最重要。""",
        "metadata": {"category": "FAQ", "type": "效果"}
    },
    {
        "id": "faq_effect_3",
        "content": """问：会不会越做越依赖？
答：头皮与头发状态会随着年龄、作息与生活习惯发生变化，定期养护有助于维持良好状态。
就像皮肤需要保养一样，头皮也需要护理。是否长期进行养护，可根据个人需求自主选择。""",
        "metadata": {"category": "FAQ", "type": "效果"}
    },
    {
        "id": "faq_card_1",
        "content": """问：卡可以转让吗？
答：可以的，卡可以转让给亲戚朋友使用。""",
        "metadata": {"category": "FAQ", "type": "卡种"}
    },
    {
        "id": "faq_card_2",
        "content": """问：可以退款吗？
答：如无特殊情况，卡项暂不支持退款。
如您在体验过程中有任何疑问或不适，欢迎随时与门店沟通，我们非常重视您的感受与反馈。""",
        "metadata": {"category": "FAQ", "type": "卡种"}
    },
    {
        "id": "faq_card_3",
        "content": """问：尊享保养卡和强效保养卡有什么区别？
答：尊享保养卡为年度不限次数卡项，价格13800元，适合使用频率很高、希望每天养护的用户。
强效保养卡为180次/年，价格9000元，适合高频使用、追求性价比的用户。
具体价格与次数以门店或小程序展示为准。""",
        "metadata": {"category": "FAQ", "type": "卡种"}
    },
    {
        "id": "faq_staff_1",
        "content": """问：每次给我做的是同一个人吗？
答：养护师会根据您到店的时间安排。
如您希望指定某位养护师，可提前预约，我们会尽量为您协调安排。""",
        "metadata": {"category": "FAQ", "type": "服务体验"}
    },
    {
        "id": "faq_staff_2",
        "content": """问：员工是否经过培训？
答：所有养护师在上岗前均需完成系统培训，并定期参加技能提升与服务培训，以保障服务质量与体验。""",
        "metadata": {"category": "FAQ", "type": "服务体验"}
    },
    {
        "id": "faq_staff_3",
        "content": """问：中途不舒服可以停吗？
答：当然可以。如您在任何环节感到不适，欢迎随时告知养护师，我们会及时调整水温、手法或暂停服务，以确保您的舒适体验。""",
        "metadata": {"category": "FAQ", "type": "服务体验"}
    },
    {
        "id": "faq_ai_1",
        "content": """问：燕儿是谁？
答：燕儿是燕斛堂的智能养护助手，可以帮助您了解服务信息、查看使用记录，提供日常养护建议。
有什么问题都可以问我哦！""",
        "metadata": {"category": "FAQ", "type": "AI"}
    },
    {
        "id": "faq_ai_2",
        "content": """问：燕儿是医生吗？
答：不是的。燕儿并非医生，提供的内容仅作为日常养护参考，不构成任何医疗建议。
如有健康问题，请咨询专业医生。""",
        "metadata": {"category": "FAQ", "type": "AI"}
    },
    {
        "id": "faq_ai_3",
        "content": """问：燕儿给的建议准吗？
答：燕儿提供的是参考方案，具体情况请以理疗师到店评估后的结论为准。
如果您想得到更准确的建议，欢迎预约到店体验。""",
        "metadata": {"category": "FAQ", "type": "AI"}
    },
    {
        "id": "faq_privacy",
        "content": """问：我的信息安全吗？
答：燕斛堂非常重视用户信息的保护，相关数据仅用于服务与体验优化，不会用于其他用途。""",
        "metadata": {"category": "FAQ", "type": "隐私"}
    },
]


def init_knowledge_base():
    """初始化知识库"""
    print("开始初始化知识库...")
    
    # 清空旧数据
    print("清空旧数据...")
    rag_service.clear()
    
    # 合并所有文档
    all_docs = SERVICE_DOCS + CARD_DOCS + FAQ_DOCS
    
    # 添加文档
    print(f"导入 {len(all_docs)} 条知识...")
    rag_service.add_documents(all_docs)
    
    # 验证
    count = rag_service.get_count()
    print(f"知识库初始化完成，共 {count} 条知识")
    
    # 测试搜索
    print("\n测试搜索:")
    test_queries = [
        "脱发怎么办",
        "泡头多少钱",
        "燕斛堂是正规的吗"
    ]
    
    for query in test_queries:
        print(f"\n问: {query}")
        results = rag_service.search(query, n_results=2)
        for i, r in enumerate(results):
            print(f"  [{i+1}] {r['content'][:80]}...")


if __name__ == "__main__":
    init_knowledge_base()
