<!-- pages/appointment/appointment.wxml -->
<view class="appointment-page">
  <!-- æ­¥éª¤æŒ‡ç¤º -->
  <view class="steps">
    <view class="step {{step >= 1 ? 'active' : ''}}">
      <view class="step-num">1</view>
      <view class="step-text">é—¨åº—</view>
    </view>
    <view class="step-line {{step >= 2 ? 'active' : ''}}"></view>
    <view class="step {{step >= 2 ? 'active' : ''}}">
      <view class="step-num">2</view>
      <view class="step-text">ä¼šå‘˜</view>
    </view>
    <view class="step-line {{step >= 3 ? 'active' : ''}}"></view>
    <view class="step {{step >= 3 ? 'active' : ''}}">
      <view class="step-num">3</view>
      <view class="step-text">æœåŠ¡</view>
    </view>
    <view class="step-line {{step >= 4 ? 'active' : ''}}"></view>
    <view class="step {{step >= 4 ? 'active' : ''}}">
      <view class="step-num">4</view>
      <view class="step-text">æ—¶é—´</view>
    </view>
  </view>

  <!-- è¿”å›æŒ‰é’® -->
  <view class="back-btn" wx:if="{{step > 1}}" bindtap="goBack">
    <text class="back-icon">â†</text>
    <text>è¿”å›ä¸Šä¸€æ­¥</text>
  </view>

  <!-- æ­¥éª¤1: é€‰æ‹©é—¨åº— -->
  <view class="step-content" wx:if="{{step === 1}}">
    <view class="section-title">é€‰æ‹©é—¨åº—</view>
    <view class="store-list">
      <view 
        class="store-item {{selectedStore && selectedStore.id === item.id ? 'selected' : ''}}"
        wx:for="{{stores}}"
        wx:key="id"
        bindtap="selectStore"
        data-store="{{item}}"
      >
        <view class="store-name">{{item.name}}</view>
        <view class="store-address">{{item.address}}</view>
      </view>
    </view>
  </view>

  <!-- æ­¥éª¤2: æ˜¯å¦ä¼šå‘˜ -->
  <view class="step-content" wx:if="{{step === 2}}">
    <!-- å·²é€‰é—¨åº— -->
    <view class="selected-info">
      <text class="label">é—¨åº—ï¼š</text>
      <text class="value">{{selectedStore.name}}</text>
    </view>

    <view class="section-title">æ‚¨æ˜¯ä¼šå‘˜å—ï¼Ÿ</view>
    <view class="member-options">
      <view 
        class="member-option {{isMember === true ? 'selected' : ''}}"
        bindtap="selectMemberStatus"
        data-ismember="{{true}}"
      >
        <view class="member-icon">ğŸ’³</view>
        <view class="member-text">æˆ‘æœ‰å¡</view>
        <view class="member-desc">ä½¿ç”¨ä¼šå‘˜å¡é¢„çº¦</view>
      </view>
      <view 
        class="member-option {{isMember === false ? 'selected' : ''}}"
        bindtap="selectMemberStatus"
        data-ismember="{{false}}"
      >
        <view class="member-icon">ğŸ‘¤</view>
        <view class="member-text">æˆ‘æ²¡æœ‰å¡</view>
        <view class="member-desc">æ•£å®¢é¢„çº¦</view>
      </view>
    </view>
  </view>

  <!-- æ­¥éª¤3: é€‰æœåŠ¡ -->
  <view class="step-content" wx:if="{{step === 3}}">
    <!-- å·²é€‰ä¿¡æ¯ -->
    <view class="selected-info">
      <text class="label">é—¨åº—ï¼š</text>
      <text class="value">{{selectedStore.name}}</text>
    </view>

    <!-- ä¼šå‘˜ï¼šæ˜¾ç¤ºå¡åˆ—è¡¨ -->
    <block wx:if="{{isMember}}">
      <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
      
      <block wx:elif="{{userCards.length > 0}}">
        <view class="section-title">é€‰æ‹©æ‚¨çš„å¡</view>
        <view class="card-list">
          <view 
            class="card-item {{selectedCard && selectedCard.id === item.id ? 'selected' : ''}} {{item.isExpired || item.remaining_times <= 0 ? 'disabled' : ''}}"
            wx:for="{{userCards}}"
            wx:key="id"
            bindtap="selectCard"
            data-card="{{item}}"
          >
            <view class="card-header">
              <view class="card-name">{{item.card_name}}</view>
              <view class="card-status {{item.isExpired ? 'expired' : (item.remaining_times <= 0 ? 'used' : 'valid')}}">
                {{item.isExpired ? 'å·²è¿‡æœŸ' : (item.remaining_times <= 0 ? 'å·²ç”¨å®Œ' : 'æœ‰æ•ˆ')}}
              </view>
            </view>
            <view class="card-info">
              <text class="card-times">å‰©ä½™ {{item.remaining_times}} æ¬¡</text>
              <text class="card-expire">æœ‰æ•ˆæœŸè‡³ï¼š{{item.expireDateDisplay}}</text>
            </view>
          </view>
        </view>

        <!-- é€‰ä¸­å¡åæ˜¾ç¤ºå¯é€‰æœåŠ¡ -->
        <block wx:if="{{selectedCard}}">
          <view class="section-title">é€‰æ‹©æœåŠ¡ï¼ˆå¯å¤šé€‰ï¼‰</view>
          <view class="service-list">
            <view 
              class="service-item {{item.isSelected ? 'selected' : ''}}"
              wx:for="{{selectedCard.availableServices}}"
              wx:key="type"
              bindtap="toggleService"
              data-service="{{item}}"
            >
              <view class="service-check">{{item.isSelected ? 'âœ“' : ''}}</view>
              <view class="service-icon">{{item.icon}}</view>
              <view class="service-info">
                <view class="service-name">{{item.name}}</view>
                <view class="service-duration">çº¦{{item.duration}}åˆ†é’Ÿ</view>
              </view>
            </view>
          </view>
        </block>
      </block>

      <view wx:else class="empty">
        <text>æ‚¨è¿˜æ²¡æœ‰ä¼šå‘˜å¡</text>
        <view class="empty-tip">è¯·è”ç³»é—¨åº—åŠç†æˆ–é€‰æ‹©æ•£å®¢é¢„çº¦</view>
        <view class="retry-btn" bindtap="goBack">è¿”å›é€‰æ‹©"æ²¡æœ‰å¡"</view>
      </view>
    </block>

    <!-- éä¼šå‘˜ï¼šæ˜¾ç¤ºæ‰€æœ‰æœåŠ¡ -->
    <block wx:else>
      <view class="section-title">é€‰æ‹©æœåŠ¡ï¼ˆå¯å¤šé€‰ï¼‰</view>
      <view class="service-list multi">
        <view 
          class="service-item {{item.isSelected ? 'selected' : ''}}"
          wx:for="{{guestServices}}"
          wx:key="type"
          bindtap="toggleService"
          data-service="{{item}}"
        >
          <view class="service-check">{{item.isSelected ? 'âœ“' : ''}}</view>
          <view class="service-icon">{{item.icon}}</view>
          <view class="service-info">
            <view class="service-name">{{item.name}}</view>
            <view class="service-duration">çº¦{{item.duration}}åˆ†é’Ÿ</view>
          </view>
        </view>
      </view>
    </block>

    <!-- ä¸‹ä¸€æ­¥æŒ‰é’® -->
    <view class="next-btn-container" wx:if="{{selectedServices.length > 0}}">
      <button class="btn-primary next-btn" bindtap="goToSelectTime">
        ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©æ—¶é—´
      </button>
    </view>
  </view>

  <!-- æ­¥éª¤4: é€‰æ‹©æ—¶é—´ -->
  <view class="step-content" wx:if="{{step === 4}}">
    <!-- å·²é€‰ä¿¡æ¯ -->
    <view class="selected-info">
      <text class="label">é—¨åº—ï¼š</text>
      <text class="value">{{selectedStore.name}}</text>
    </view>
    <view class="selected-info">
      <text class="label">æœåŠ¡ï¼š</text>
      <text class="value">
        <text wx:for="{{selectedServices}}" wx:key="type">{{item.name}}{{index < selectedServices.length - 1 ? 'ã€' : ''}}</text>
      </text>
    </view>
    <view class="selected-info" wx:if="{{isMember && selectedCard}}">
      <text class="label">ä½¿ç”¨å¡ï¼š</text>
      <text class="value">{{selectedCard.card_name}}</text>
    </view>

    <!-- é€‰æ‹©æ—¥æœŸ -->
    <view class="section-title">é€‰æ‹©æ—¥æœŸ</view>
    <scroll-view class="date-scroll" scroll-x>
      <view class="date-list">
        <view 
          class="date-item {{selectedDate === item.date ? 'selected' : ''}}"
          wx:for="{{dates}}"
          wx:key="date"
          bindtap="selectDate"
          data-date="{{item.date}}"
        >
          <view class="date-weekday">{{item.weekDay}}</view>
          <view class="date-day">{{item.display}}</view>
        </view>
      </view>
    </scroll-view>

    <view wx:if="{{selectedDate}}">
      <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>

      <view wx:elif="{{availableStaff.length === 0}}" class="empty">
        <text>è¯¥æ—¶æ®µæš‚æ— å¯é¢„çº¦çš„å‘˜å·¥</text>
        <view class="empty-tip">è¯·é€‰æ‹©å…¶ä»–æ—¥æœŸ</view>
      </view>

      <view wx:else>
        <!-- é€‰æ‹©å‘˜å·¥ -->
        <view class="section-title">é€‰æ‹©æŠ€å¸ˆ</view>
        <view class="staff-list">
          <view 
            class="staff-item {{selectedStaff && selectedStaff.staff.id === item.staff.id ? 'selected' : ''}}"
            wx:for="{{availableStaff}}"
            wx:key="index"
            bindtap="selectStaff"
            data-staff="{{item}}"
          >
            <view class="staff-avatar">ğŸ‘©</view>
            <view class="staff-info">
              <view class="staff-name">{{item.staff.real_name || item.staff.nickname || 'æŠ€å¸ˆ'}}</view>
              <view class="staff-intro">{{item.staff.introduction || 'ä¸“ä¸šæœåŠ¡'}}</view>
            </view>
          </view>
        </view>

        <!-- é€‰æ‹©æ—¶é—´ -->
        <view wx:if="{{selectedStaff}}" class="time-section">
          <view class="section-title">é€‰æ‹©æ—¶é—´</view>
          <view class="time-grid">
            <view 
              class="time-item {{selectedTime === item ? 'selected' : ''}}"
              wx:for="{{selectedStaff.available_times}}"
              wx:key="*this"
              bindtap="selectTime"
              data-time="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æŒ‰é’® -->
  <view class="bottom-bar" wx:if="{{step === 4 && selectedTime}}">
    <view class="summary">
      <view>{{selectedStore.name}}</view>
      <view>{{selectedDate}} {{selectedTime}}</view>
    </view>
    <button class="btn-primary submit-btn" bindtap="submitAppointment" loading="{{loading}}">
      ç¡®è®¤é¢„çº¦
    </button>
  </view>
</view>
