<!-- pages/my/my.wxml -->
<view class="my-page">
  <!-- ç”¨æˆ·ä¿¡æ¯ -->
  <view class="user-section" wx:if="{{userInfo}}">
    <view class="user-avatar">{{userInfo.nickname ? userInfo.nickname[0] : 'ç”¨'}}</view>
    <view class="user-info">
      <view class="user-name">{{userInfo.nickname || 'ç”¨æˆ·'}}</view>
      <view class="user-phone" wx:if="{{userInfo.phone}}">{{userInfo.phone}}</view>
      <view class="user-role">{{userInfo.role === 'staff' || userInfo.role === 'admin' ? 'å‘˜å·¥' : 'é¡¾å®¢'}}</view>
    </view>
    <view class="bind-phone-btn" wx:if="{{!userInfo.phone}}" bindtap="showBindPhone">
      ç»‘å®šæ‰‹æœºå·
    </view>
  </view>

  <!-- ç»‘å®šæ‰‹æœºå·å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showPhoneModal}}" bindtap="hideBindPhone"></view>
  <view class="modal-content" wx:if="{{showPhoneModal}}">
    <view class="modal-title">ç»‘å®šæ‰‹æœºå·</view>
    <view class="modal-desc">ç»‘å®šåå¯ä»¥åŒæ­¥æ‚¨çš„ä¼šå‘˜å¡ä¿¡æ¯</view>
    <input 
      class="phone-input"
      type="number"
      maxlength="11"
      placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
      value="{{bindPhone}}"
      bindinput="onBindPhoneInput"
    />
    <view class="modal-buttons">
      <button class="modal-btn cancel" bindtap="hideBindPhone">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="confirmBindPhone">ç¡®è®¤ç»‘å®š</button>
    </view>
  </view>

  <!-- Tabåˆ‡æ¢ -->
  <view class="tabs">
    <view 
      class="tab {{activeTab === 'cards' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="cards"
    >
      æˆ‘çš„ç–—ç¨‹å¡
    </view>
    <view 
      class="tab {{activeTab === 'appointments' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="appointments"
    >
      æˆ‘çš„é¢„çº¦
    </view>
  </view>

  <!-- æˆ‘çš„ç–—ç¨‹å¡ -->
  <view class="tab-content" wx:if="{{activeTab === 'cards'}}">
    <view wx:if="{{myCards.length === 0}}" class="empty">
      <view class="empty-icon">ğŸ’³</view>
      <view>æš‚æ— ç–—ç¨‹å¡</view>
      <view class="empty-tip">è¯·è”ç³»åº—å‘˜åŠç†</view>
    </view>
    
    <view class="card-list" wx:else>
      <view 
        class="card-item {{item.is_expired ? 'expired' : ''}}"
        wx:for="{{myCards}}"
        wx:key="id"
      >
        <view class="card-header">
          <view class="card-name">{{item.card_name}}</view>
          <view class="card-status" wx:if="{{item.is_expired}}">å·²è¿‡æœŸ</view>
        </view>
        <view class="card-body">
          <view class="card-times">
            <view class="times-label">å‰©ä½™æ¬¡æ•°</view>
            <view class="times-value">{{item.remaining_times || 'æ— é™'}}</view>
          </view>
          <view class="card-expire" wx:if="{{item.expire_date}}">
            æœ‰æ•ˆæœŸè‡³ï¼š{{item.expire_date}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆ‘çš„é¢„çº¦ -->
  <view class="tab-content" wx:if="{{activeTab === 'appointments'}}">
    <view wx:if="{{myAppointments.length === 0}}" class="empty">
      <view class="empty-icon">ğŸ“…</view>
      <view>æš‚æ— é¢„çº¦</view>
      <view class="empty-tip">å»é¦–é¡µé€‰æ‹©é—¨åº—é¢„çº¦å§</view>
    </view>
    
    <view class="appointment-list" wx:else>
      <view 
        class="appointment-item"
        wx:for="{{myAppointments}}"
        wx:key="id"
      >
        <view class="apt-header">
          <view class="apt-service">{{item.serviceText}}</view>
          <view class="apt-status {{item.status}}">{{item.statusText}}</view>
        </view>
        <view class="apt-body">
          <view class="apt-info">ğŸ“ {{item.store.name}}</view>
          <view class="apt-info">ğŸ‘© {{item.staff.real_name || item.staff.nickname || 'æŠ€å¸ˆ'}}</view>
          <view class="apt-info">ğŸ“… {{item.appointment_date}} {{item.start_time}}</view>
        </view>
        <view class="apt-actions" wx:if="{{item.status === 'pending' || item.status === 'confirmed'}}">
          <button 
            class="cancel-btn"
            size="mini"
            bindtap="cancelAppointment"
            data-id="{{item.id}}"
          >
            å–æ¶ˆé¢„çº¦
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½èœå• -->
  <view class="menu-section">
    <view class="menu-item" bindtap="goToStaff" wx:if="{{userInfo.role === 'staff' || userInfo.role === 'admin'}}">
      <text class="menu-icon">ğŸ‘©â€ğŸ’¼</text>
      <text class="menu-text">è¿›å…¥å‘˜å·¥ç«¯</text>
      <text class="menu-arrow">â€º</text>
    </view>
    <view class="menu-item" bindtap="logout">
      <text class="menu-icon">ğŸšª</text>
      <text class="menu-text">é€€å‡ºç™»å½•</text>
      <text class="menu-arrow">â€º</text>
    </view>
  </view>
</view>
